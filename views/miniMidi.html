<!DOCTYPE html>
<html lang="en">
<head>
  <!--char set (lang above)-->
  <meta charset="utf-8">

  <!--device/browser shizzle-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--meta content-->
  <link rel="shortcut icon" href="public/favicon.ico" />
  <link rel="apple-touch-icon" href="/public/images/apple-touch-icon.png" />
  <meta name="author" content="Ruth John (@rumyra)">
  <meta name="dcterms.rightsHolder" content="Ruth John for Rumyra Ltd, United Kingdom, 2015">
  <link rel="stylesheet" href="css/miniMidi.css" id="theme">
  <title>Come to Rumyras party!</title>
  <script src="https://js.pusher.com/3.0/pusher.min.js"></script>
  <script src="audioVisual.js"></script>
</head>
<body>
<div class="container">

  <section id="party-invite">
    <h2>You've been invited to Ruth's Party!</h2>
    <form method="post" action="/">
      <label for="git-name">Please enter your github username to accept the invite:</label>
      <input type="text" name="git-name" id="git-name" placeholder="octocat" />
      <input type="submit" value="Join The Party" />
    </form>
  </section>

  <section id="holding">
    <h2>Heya ... welcome to the party! Hang in there - the awesome is just about to start!</h2>
    <p>Don't close your browser :)</p>
  </section>

  <section id="music-midi-control">
    <button class="pad pad-active">MIDI PAD</button>
    <div class="dial">
      <div class="knob"></div>
      <div class="dial-active"></div>
    </div>
  </section>

  <section id="visual-midi-control">
    <button class="pad">MIDI PAD</button>
    <div class="dial">
      <div class="knob"></div>
      <div class="dial-active"></div>
    </div>
  </section>

</div>

<div id="pusher" data-key="{{PUSH_KEY}}"></div>
<script type="text/javascript">

  // dom vars
  var inviteForm = document.getElementById('party-invite'),
    holdingDiv = document.getElementById('holding'),

    musicMidi = document.getElementById('music-midi-control'),
    musicPad = musicMidi.getElementsByClassName('pad')[0],
    musicDial = musicMidi.getElementsByClassName('dial')[0],
    musicKnob = musicMidi.getElementsByClassName('knob')[0],
    musicActive = musicMidi.getElementsByClassName('dial-active')[0],

    visualMidi = document.getElementById('visual-midi-control'),
    visualPad = visualMidi.getElementsByClassName('pad')[0],
    visualDial = visualMidi.getElementsByClassName('dial')[0],
    visualKnob = visualMidi.getElementsByClassName('knob')[0],
    visualActive = visualMidi.getElementsByClassName('dial-active')[0];

  // establish connection with pusher
  var config = document.getElementById('pusher').dataset;
  var pusher = new Pusher(config.key, {encrypted:true});

  Pusher.channel_auth_endpoint = 'http://39367a56.ngrok.io/pusher/auth';
  pusher.connection.bind('state_change', function(states) {
      console.log("Pusher's current state is " + states.current);
  });

  // subscribe to channel
  var channel = pusher.subscribe('private-party_channel');

  channel.bind('pusher:subscription_succeeded', function() {
    console.log('subscription succeeded');
  });

// CHECK ALL STUFF ABOVE THIS POINT - PROBS NOT NEEDED
// Form stuff ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
var username = '';
var avatar = '';
var inviteForm = document.forms[0];

function formStuff() {
  
  console.log(inviteForm);

  if ( (inviteForm['git-name'].value == '') || (inviteForm['git-name'].value == 'octocat') ) {

    var label = inviteForm.querySelector('label');
    label.className = 'label-warn';

  } else {

    // grab username
    cleanString = inviteForm['git-name'].value.replace(/[^a-zA-Z0-9\s]/g, '').replace(/^\s+|\s+$/, '').replace(/\s+/g, '').toLowerCase();
    username = cleanString;
    // send event
    getGitAvatar(username);
    // show hide form
    inviteForm.style.display = 'none';
    holdingDiv.style.display = 'block';

  }
}
inviteForm.addEventListener("submit", function(ev) {
  ev.preventDefault();
  formStuff();
  console.log(username);  
});

function getGitAvatar(username) {
  function getPicUrl() {
    var responseObj = JSON.parse(this.responseText);
    // console.log(responseObj.avatar_url);
    avatar = responseObj.avatar_url;
    channel.trigger(
      'client-register_user',
      {
        "userId": username,
        "userAvatar": avatar
      }
    );
  }
  var request = new XMLHttpRequest();
  request.onload = getPicUrl;
  request.open('get', 'https://api.github.com/users/'+username, true)
  request.send()
}

// audio stuff
channel.bind('client-show_music', function(data) {
  inviteForm.style.display = 'none';
  holdingDiv.style.display = 'none';
  musicMidi.style.display = 'block';
  dial(musicDial, musicKnob, musicActive);
});
var audioAPI = new (window.AudioContext || window.webkitAudioContext)();
var oscillator,
  freqIndex = getRandomInt(0,5),
  frequency = oscillatorOpts.frequencies[freqIndex],
  fxIndex = getRandomInt(1,3),
  waveIndex = getRandomInt(0,2),
  waveType = oscillatorOpts.waveTypes[waveIndex],
  playing = false;
  console.log(freqIndex+'-'+fxIndex+'-'+waveIndex);
musicPad.addEventListener('click', function(event) {
  if (playing) {
    destroyOsc(oscillator.osc);
    playing = false;
  } else {
    oscillator = createOsc(audioAPI, frequency, fxIndex, waveType);
    switch (fxIndex) {
      case 1:
        updateFxOne();
        break;
      case 2:
        updateFxTwo();
        break;
      case 3:
        updateFxThree();
        break;
    }
    playing = true;
  }
});

function updateFxOne() {
  requestAnimationFrame(updateFxOne);
  oscillator.fx.frequency.value = (dialVal*10)+200;
}
function updateFxTwo() {
  requestAnimationFrame(updateFxTwo);
  oscillator.fx.frequency.value = dialVal*10;
}
function updateFxThree() {
  requestAnimationFrame(updateFxThree);
  oscillator.fx.curve = makeDistortionCurve(dialVal*10);
}


// Visual demo
channel.bind('client-show_visual', function(data) {
  console.log(data);
  musicMidi.style.display = 'none';
  visualMidi.style.display = 'block';
  document.getElementsByTagName('body')[0].className = 'midi-light';
  dialVal = 0;
  dial(visualDial, visualKnob, visualActive, true);
});
// press button send invert event
var visualMidi = document.getElementById('visual-midi-control');
var visualPad = visualMidi.getElementsByClassName('pad')[0];

var inverted = false;
visualPad.addEventListener("click", function(ev) {
  inverted = inverted ? false : true;
  console.log('clicked');
  channel.trigger(
    'client-invert',
    {
      "userId": username,
      "invert": inverted
    }
  );
});
visualDial.addEventListener('mousedown', function(ev) {
  
  var sendRotate = window.setInterval(function() {
    console.log(dialVal);
    channel.trigger(
      'client-rotate',
      {
        "userId": username,
        "rotate": dialVal
      }
    );
  }, 5000);

  this.addEventListener('mouseup', function() {
    window.clearInterval(sendRotate);
  });

});


</script>

</body>
</html>
