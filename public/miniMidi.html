<!DOCTYPE html>
<html lang="en">
<head>
  <!--char set (lang above)-->
  <meta charset="utf-8">

  <!--device/browser shizzle-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--meta content-->
  <link rel="shortcut icon" href="public/favicon.ico" />
  <link rel="apple-touch-icon" href="/public/images/apple-touch-icon.png" />
  <meta name="author" content="Ruth John (@rumyra)">
  <meta name="dcterms.rightsHolder" content="Ruth John for Rumyra Ltd, United Kingdom, 2015">
  <link rel="stylesheet" href="css/miniMidi.css" id="theme">
  <title>Come to Rumyras party!</title>
  <script src="https://js.pusher.com/3.0/pusher.min.js"></script>
  <script src="audioVisual.js"></script>
</head>
<body class="mini-midi">
<div class="container">

  <section id="party-invite">
    <h2>You've been invited to Ruth's Party!</h2>
    <form method="post" action="/">
      <label for="git-name">Please enter your github username to accept the invite:</label>
      <input type="text" name="git-name" id="git-name" placeholder="octocat" />
      <input type="submit" value="Join The Party" />
    </form>
  </section>

  <section id="holding">
    <h2>Heya ... welcome to the party! Hang in there - the awesome is just about to start!</h2>
    <p>Don't close your browser :)</p>
  </section>

  <section id="music-midi-control">
    <button class="pad pad-active">MIDI PAD</button>
    <div class="dial">
      <div class="knob"></div>
      <div class="dial-active"></div>
    </div>
  </section>

  <section id="visual-midi-control">
    <button class="pad">MIDI PAD</button>
    <div class="dial">
      <div class="knob"></div>
      <div class="dial-active"></div>
    </div>
  </section>

</div>
<script type="text/javascript">

  // establish connection with pusher

  var pusher = new Pusher('b6780dee2b18b6b295d7', {encrypted:true});

  Pusher.channel_auth_endpoint = 'http://39367a56.ngrok.io/pusher/auth';
  pusher.connection.bind('state_change', function(states) {
      console.log("Pusher's current state is " + states.current);
  });

  // subscribe to channel
  var channel = pusher.subscribe('private-party_channel');

  channel.bind('pusher:subscription_succeeded', function() {
    console.log('subscription succeeded');
  });


  // callback on event
  channel.bind('client-send_to_midi', function(data) {
    console.log(data.midi_data);
  });

  //get a reference to the element
  var sendToMeBut = document.getElementById('music-midi-control').getElementsByClassName('pad')[0];

  //add event listener
  sendToMeBut.addEventListener('click', function(event) {
    channel.trigger(
      'client-send_to_talk',
      {
        "midi_data": [144, 48, 127]
      }
    );
    
  });
  sendToMeBut.addEventListener('mousedown', function(event) {
    var note = new Note(220, 60);
    note.play();
    this.addEventListener('mouseup', function(event) {
      note.stop();
    });
  });

// Form stuff ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
var username = '';
var avatar = '';
var inviteForm = document.forms[0];

function formStuff() {
  
  console.log(inviteForm);

  if ( (inviteForm['git-name'].value == '') || (inviteForm['git-name'].value == 'octocat') ) {

    var label = inviteForm.querySelector('label');
    label.className = 'label-warn';

  } else {

    // grab username
    cleanString = inviteForm['git-name'].value.replace(/[^a-zA-Z0-9\s]/g, '').replace(/^\s+|\s+$/, '').replace(/\s+/g, '').toLowerCase();
    username = cleanString;
    // send event
    getGitAvatar(username);
    // show hide form
    document.getElementById('party-invite').style.display = 'none';
    document.getElementById('holding').style.display = 'block';

  }
}
inviteForm.addEventListener("submit", function(ev) {
  ev.preventDefault();
  formStuff();
  console.log(username);  
})

function getGitAvatar(username) {
  function getPicUrl() {
    var responseObj = JSON.parse(this.responseText);
    // console.log(responseObj.avatar_url);
    avatar = responseObj.avatar_url;
    channel.trigger(
      'client-register_user',
      {
        "userId": username,
        "userAvatar": avatar
      }
    );
  }
  var request = new XMLHttpRequest();
  request.onload = getPicUrl;
  request.open('get', 'https://api.github.com/users/'+username, true)
  request.send()
}



// dial stuff ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
dial();

</script>

</body>
</html>
